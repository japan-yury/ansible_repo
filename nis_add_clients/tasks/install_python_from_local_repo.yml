---
- name: Check of availability of the local Repo before python3 installation
  uri:
    url: "{{ local_repo_hostname }}/pub/Distros/"
  register: local_repo_output
  ignore_errors: yes

- name: Message out when unable to install python on the host due to unavailability of the repository
  fail:
    msg: "Unable to install python on the host due to unavailability of the repository"
  when: local_repo_output.status != 200

- name: Display a link to repository
  debug:
    var: repo_link
  when: repo_link is defined

- name: Downloading and creating a reference to internal Dell Repo for RHEL 6.x version
  raw: "curl {{ local_repo_hostname }}/{{ repo_link }} -o /etc/yum.repos.d/dell-rhel6.repo"
  args:
    executable: /bin/bash
  ignore_errors: yes
  register: repo_link_downloaded_status
  when: (repo_link is defined) and
        ((trimmed_os_name is defined and os[trimmed_os_name]['os_family'] == 'rhel_6') or
        (os_name_via_hostnamectl is defined and os[os_name_via_hostnamectl]['os_family'] == 'rhel_6') or
        (os_name_other is defined and os[os_name_other]['os_family'] == 'rhel_6'))

- name: Downloading and creating a reference to internal Dell Repo for RHEL 7.x version
  raw: "curl {{ local_repo_hostname }}/{{ repo_link }} -o /etc/yum.repos.d/dell-rhel7.repo"
  args:
    executable: /bin/bash
  ignore_errors: yes
  register: repo_link_downloaded_status
  when: (repo_link is defined) and
        ((trimmed_os_name is defined and os[trimmed_os_name]['os_family'] == 'rhel_7') or
        (os_name_via_hostnamectl is defined and os[os_name_via_hostnamectl]['os_family'] == 'rhel_7') or
        (os_name_other is defined and os[os_name_other]['os_family'] == 'rhel_7'))

- name: Block for RHEL 8.x version
  block:
    - name: Create BaseOS.repo configuration file (IF FAILED - Unable to identify the OS)
      template:
        src: BaseOS.repo.j2
        dest: /etc/yum.repos.d/BaseOS.repo

    - name: Create AppStream.repo configuration file (IF FAILED - Unable to identify the OS)
      template:
        src: AppStream.repo.j2
        dest: /etc/yum.repos.d/AppStream.repo
  when: (repo_link is defined) and
        ((trimmed_os_name is defined and os[trimmed_os_name]['os_family'] == 'rhel_8') or
        (os_name_via_hostnamectl is defined and os[os_name_via_hostnamectl]['os_family'] == 'rhel_8') or
        (os_name_other is defined and os[os_name_other]['os_family'] == 'rhel_8'))

- name: Downloading and creating a reference to internal Dell Repo for SLES 12 version
  raw: "curl {{ local_repo_hostname }}/{{ repo_link }} -o /etc/zypp/repos.d/dell-sles12.repo"
  args:
    executable: /bin/bash
  ignore_errors: yes
  register: repo_link_downloaded_status
  when: (repo_link is defined) and
        ((trimmed_os_name is defined and os[trimmed_os_name]['os_family'] == 'suse_12') or
        (os_name_via_hostnamectl is defined and os[os_name_via_hostnamectl]['os_family'] == 'suse_12') or
        (os_name_other is defined and os[os_name_other]['os_family'] == 'suse_12'))

- name: Installing the 'libselinux-python' from a local repository
  raw: "{{ package_manager }} install -y libselinux-python --skip-broken"
  args:
    executable: /bin/bash
  ignore_errors: yes
  register: libselinux_python_installation
  when:
    - grant_sudo_second_try is failed
    - grant_sudo_second_try.msg is defined
    - "'target uses selinux' in grant_sudo_second_try.msg"

- name: Installing the python version 3 from a local repository
  raw: "{{ package_manager }} install -y python3"
  args:
    executable: /bin/bash
  ignore_errors: yes
  register: python3_installation
  when: (python_installation is failed) or
        (repo_link_downloaded_status is succeeded and libselinux_python_installation is failed)

- name: Finalizing package update
  shell: yum-complete-transaction --cleanup-only
  args:
    executable: /bin/bash
  ignore_errors: yes
  delegate_to: localhost
  when: python3_installation is failed

- name: Message out when python installation is finished
  debug:
    msg: "Python installation is finished with message: {{ python3_installation }}"
  when: python3_installation is succeeded

- name: Reverting the configuration set to point to a local repository for python installation
  file:
    state: absent
    path: "{{ item }}"
  with_items:
     - /etc/yum.repos.d/dell-rhel6.repo
     - /etc/yum.repos.d/dell-rhel7.repo
     - /etc/yum.repos.d/AppStream.repo
     - /etc/yum.repos.d/BaseOS.repo
     - /etc/zypp/repos.d/dell-sles12.repo
